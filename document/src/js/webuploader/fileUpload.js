/*! 
*  frontui v1.0.2
*  by frontpay FE Team
*  (c) 2016-03-25 www.frontpay.cn
*  Licensed under Apache License
*/
!function(e,t){"function"==typeof define&&define.amd?define("ui/fileUpload",["jquery","webuploader"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("webuploader")):t(e.jQuery)}(this,function(e){"use strict";function t(t){var i=[].slice.call(arguments,1);return e(this).each(function(){var a=e(this),s=a.data("ui.fileUpload");s||(s=new n(a,t),a.data("ui.fileUpload",s)),"string"==typeof t&&s[t]&&s[t](i)})}var i={},a=function(){var e=new Image,t=!0;return e.onload=e.onerror=function(){(1!=this.width||1!=this.height)&&(t=!1)},e.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",t}(),s=function(){var e;try{e=navigator.plugins["Shockwave Flash"],e=e.description}catch(t){try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(i){e="0.0"}}return e=e.match(/\d+/g),parseFloat(e[0]+"."+e[1],10)}(),o=function(){var e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,t}(),n=function(t,i){this.$el=e(t),this.options=e.extend({},n.DEFAULTS,i),this.uploader=null,this.init()};return n.DEFAULTS={tpl:'<div class="img-editor">   <div class="queueList"></div>   <div class="statusBar">       <div class="info"></div>       <div class="btns">           <div class="uploadBtn">\u5f00\u59cb\u4e0a\u4f20</div>       </div>   </div></div>',auto:!1,multiple:!1,water:!1,thumbnail:!1,sendurl:null,fileVal:"File",filetypes:"jpg,jpeg,bmp,png,gif,pdf,doc,docx",filesize:"204800",btntext:"\u70b9\u51fb\u4e0a\u4f20",swf:null,thumbnailWidth:400,thumbnailHeight:400,success:e.noop},n.prototype={constructor:n,init:function(){if(!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie){var t=this.options.swf;return void(s?!function(e){window.expressinstallcallback=function(e){switch(e){case"Download.Cancelled":alert("\u60a8\u53d6\u6d88\u4e86\u66f4\u65b0\uff01");break;case"Download.Failed":alert("\u5b89\u88c5\u5931\u8d25");break;default:alert("\u5b89\u88c5\u5df2\u6210\u529f\uff0c\u8bf7\u5237\u65b0\uff01")}delete window.expressinstallcallback};var i=t.split("/"),a=i.slice(0,i.length-1).join("/"),s=a+"/expressInstall.swf",o='<object type="application/x-shockwave-flash" data="'+s+'" ';WebUploader.browser.ie&&(o+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '),o+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+s+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>',e.html(o)}(this.$el.parent()):this.$el.parent().html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>'))}return WebUploader.Uploader.support()?(this.$editor=e(this.options.tpl),this.$el.after(this.$editor),this.$uploadBtn=this.$editor.find(".uploadBtn"),this.$queueContainer=this.$editor.find(".queueList"),this.$info=this.$editor.find(".info"),this.$container=null,this.$queue=e('<ul class="filelist"></ul>').appendTo(this.$queueContainer),this.rotation=0,this.uploading=!1,void this.__initUploader()):void alert("\u5f88\u62b1\u6b49\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u4e0a\u4f20\u63a7\u4ef6\uff01")},__initUploader:function(){var e=this.options,t=this.options.sendurl;t+="?action=UploadFile",e.water&&(t+="&IsWater=1"),e.thumbnail&&(t+="&IsThumbnail=1"),e.multiple&&(t+="&DelFilePath="+this.$el.siblings(".upload-path").val()),this.uploader=WebUploader.create({auto:e.auto,swf:e.swf,server:t,pick:{id:this.$el[0],multiple:e.multiple},accept:{extensions:e.filetypes},formData:{DelFilePath:""},fileVal:e.fileVal,fileSingleSizeLimit:1024*e.filesize,compress:{quality:75}}),this.__listenUploader()},__listenUploader:function(){var e=this,t=this.options,i=this.$el,a=this.uploader;a.on("error",function(e){switch(e){case"Q_EXCEED_NUM_LIMIT":alert("\u9519\u8bef\uff1a\u4e0a\u4f20\u6587\u4ef6\u6570\u91cf\u8fc7\u591a\uff01");break;case"Q_EXCEED_SIZE_LIMIT":alert("\u9519\u8bef\uff1a\u6587\u4ef6\u603b\u5927\u5c0f\u8d85\u51fa\u9650\u5236\uff01");break;case"F_EXCEED_SIZE":alert("\u9519\u8bef\uff1a\u6587\u4ef6\u5927\u5c0f\u8d85\u51fa\u9650\u5236\uff01");break;case"Q_TYPE_DENIED":alert("\u9519\u8bef\uff1a\u7981\u6b62\u4e0a\u4f20\u8be5\u7c7b\u578b\u6587\u4ef6\uff01");break;case"F_DUPLICATE":alert("\u9519\u8bef\uff1a\u8bf7\u52ff\u91cd\u590d\u4e0a\u4f20\u8be5\u6587\u4ef6\uff01");break;default:alert("\u9519\u8bef\u4ee3\u7801\uff1a"+e)}}),a.on("fileQueued",function(s){t.multiple||(a.options.formData.DelFilePath=i.siblings(".upload-path").val()),e.__addFile(s)}),a.on("uploadBeforeSend",function(t,i){i.rotation=e.rotation}),a.on("uploadProgress",function(t,i){var a=e.$progress.find("span");a.css("width",100*i+"%"),e.$info.find(".wu-percent-text").html(",\u5df2\u4e0a\u4f20"+100*i+"%")}),a.on("uploadError",function(e,t){a.removeFile(e),alert(e.name+"\u4e0a\u4f20\u5931\u8d25\uff0c\u9519\u8bef\u4ee3\u7801\uff1a"+t)}),a.on("uploadSuccess",function(s,o){function n(){t.success(i,s,o),e.$editor.hide(),e.$container.off().remove(),e.$info.html("")}e.$container.append('<span class="success"></span>'),e.$progress.hide(),a.removeFile(s),setTimeout(n,500)}),a.on("uploadComplete",function(t){e.$uploadBtn.removeClass("disabled"),e.uploading=!1})},__addFile:function(t){var s=this,n=this.$queue,l=this.options,r=this.uploader;this.$editor.show();var d=e('<li id="'+t.id+'"><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),p=e('<div class="file-panel"><span class="cancel">\u5220\u9664</span><span class="rotateRight">\u5411\u53f3\u65cb\u8f6c</span><span class="rotateLeft">\u5411\u5de6\u65cb\u8f6c</span></div>').appendTo(d),c=d.find("p.imgWrap"),u=e('<p class="error"></p>'),h=null,f=function(e){switch(e){case"exceed_size":text="\u6587\u4ef6\u5927\u5c0f\u8d85\u51fa";break;case"interrupt":text="\u4e0a\u4f20\u6682\u505c";break;default:text="\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5"}u.text(text).appendTo(d)},m=function(){d.off().remove(),s.$editor.hide()};this.$progress=d.find("p.progress"),"invalid"===t.getStatus()?f(t.statusText):(c.text("\u9884\u89c8\u4e2d"),r.makeThumb(t,function(t,i){return t?void c.text("\u4e0d\u80fd\u9884\u89c8"):void(a&&(h=e('<img src="'+i+'">'),c.empty().append(h)))},l.thumbnailWidth,l.thumbnailHeight),i[t.id]=[t.size,0],t.rotation=0),p.on("click","span",function(){var i,a=e(this).index();switch(a){case 0:return r.removeFile(t),void m();case 1:t.rotation+=90;break;case 2:t.rotation-=90}o?(i="rotate("+t.rotation+"deg)",h.css({"-webkit-transform":i,"-mos-transform":i,"-o-transform":i,transform:i})):h.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(t.rotation/90%4+4)%4+")"),s.rotation=t.rotation}),d.appendTo(n),this.$container=d,this.$info.html(WebUploader.formatSize(i[t.id][0])+'<span class="wu-percent-text"></span>'),this.$uploadBtn.on("click",function(){s.uploading||(s.uploading=!0,s.$progress.show(),p.hide(),r.upload(),e(this).addClass("disabled"))})}},e.fn.fileUpload=t,n});